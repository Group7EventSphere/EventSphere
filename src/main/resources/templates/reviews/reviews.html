<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<!--
  This fragment renders your review section.
  Usage: <div th:replace="~{review :: reviewSection(event=${event})}"></div>
-->
<div th:fragment="reviewSection(event)">
    <section id="review-section"
             class="container"
             style="margin:2em 0;"
             th:attr="data-event-id=${event.id}">

        <h2>Review</h2>

        <!-- 1) Review Form (logged-in users only) -->
        <sec:authorize access="isAuthenticated()">
            <form id="review-form"
                  style="background:#f1f1f1; padding:1em; border-radius:8px;">

                <label>Rate your experience:</label>
                <div class="star-rating" style="font-size:1.5em;">
            <span th:each="i : ${#numbers.sequence(1,5)}">
              <input type="radio"
                     th:id="'star-' + ${i}"
                     name="rating"
                     th:value="${i}" />
              <label th:for="'star-' + ${i}">&#9733;</label>
            </span>
                </div>

                <label style="display:block; margin-top:1em;">Your review:</label>
                <textarea id="review-text"
                          name="reviewText"
                          rows="3"
                          style="width:100%; padding:.5em;"
                          placeholder="Write your review…"></textarea>

                <button type="submit"
                        style="margin-top:1em; padding:.5em 1.5em;
                         border:none; border-radius:4px;
                         background:#3b82f6; color:white;">
                    Submit
                </button>
            </form>
        </sec:authorize>

        <!-- 1b) Prompt to log in if anonymous -->
        <sec:authorize access="!isAuthenticated()">
            <p><a th:href="@{/login}">Sign in</a> to leave a review.</p>
        </sec:authorize>

        <!-- 2) Existing Reviews -->
        <div id="reviews-list"
             style="display:grid; grid-gap:1em; margin-top:2em;">
            <!-- populated by JS -->
        </div>
    </section>
</div>

<!--===== inline JS to fetch & post reviews =====-->
<script th:inline="javascript">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', () => {
        const section = document.getElementById('review-section');
        const eventId = section.getAttribute('data-event-id');
        const listEl  = document.getElementById('reviews-list');
        const form    = document.getElementById('review-form');
        const txt     = document.getElementById('review-text');

        // build a single review card
        function makeCard(r) {
            const card = document.createElement('div');
            card.style.cssText = 'background:#f1f1f1; padding:1em; border-radius:8px; display:flex; gap:1em;';
            card.innerHTML = `
          <div style="flex-shrink:0;">
            <img src="/img/default-avatar.png"
                 alt="avatar"
                 style="width:48px; height:48px; border-radius:50%;">
          </div>
          <div style="flex-grow:1;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              // <h4 style="margin:0;">${r.attendee.name}</h4>
              // <small>${new Date(r.createdAt).toLocaleDateString()}</small>
            </div>
            <div style="color:#fbbf24; font-size:1.2em; margin:0.2em 0;">
              ${Array.from({length:5}, (_,i) => i < r.rating ? '★' : '☆').join('')}
            </div>
            <p>${r.reviewText}</p>
          </div>`;
            return card;
        }

        // load & render all reviews
        async function loadReviews() {
            listEl.innerHTML = '';
            try {
                const resp = await fetch(`/reviews/event/${eventId}`);
                const reviews = await resp.json();
                if (!reviews.length) {
                    listEl.innerHTML = '<p>No reviews yet. Be the first to review!</p>';
                } else {
                    reviews.forEach(r => listEl.appendChild(makeCard(r)));
                }
            } catch (e) {
                listEl.innerHTML = `<p style="color:red">Error loading reviews: ${e}</p>`;
            }
        }

        // handle new-review submission
        if (form) {
            form.addEventListener('submit', async e => {
                e.preventDefault();
                const rating = +form.rating.value;
                const body = { reviewText: txt.value, rating };
                try {
                    const res = await fetch(`/reviews/create/${eventId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    if (!res.ok) throw new Error(await res.text());
                    form.reset();
                    await loadReviews();
                } catch (err) {
                    alert('Error posting review: ' + err);
                }
            });
        }

        // initial fetch
        loadReviews();
    });
    /*]]>*/
</script>
</html>
