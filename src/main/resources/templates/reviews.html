<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Async CRUD Test for Reviews</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 2em auto; }
        section { border: 1px solid #ddd; padding: 1em; margin-bottom: 1.5em; }
        h2 { margin-top: 0; }
        label { display: block; margin: .5em 0 .2em; }
        input, textarea, select, button { width: 100%; padding: .4em; box-sizing: border-box; }
        button { width: auto; margin-top: .5em; }
        pre { background: #f7f7f7; padding: .5em; white-space: pre-wrap; }
    </style>
</head>
<body>

<h1>Reviews – Async CRUD Testing</h1>

<section>
    <h2>View a Review</h2>
    <label for="viewSelect">Select Review ID:</label>
    <select id="viewSelect">
        <option value="">-- choose one --</option>
        <option th:each="rev : ${reviews}"
                th:value="${rev.id}"
                th:text="${rev.id}">42</option>
    </select>
    <p><strong>Text:</strong> <span id="viewText">–</span></p>
    <p><strong>Rating:</strong> <span id="viewRating">–</span></p>
    <pre id="viewRaw">–</pre>
</section>

<section>
    <h2>Create Review</h2>
    <label>Event ID:
        <input id="createEvent" type="number" placeholder="e.g. 123">
    </label>
    <label>Text:
        <textarea id="createText" placeholder="Your review…"></textarea>
    </label>
    <label>Rating (1–5):
        <input id="createRating" type="number" min="1" max="5" value="3">
    </label>
    <button id="btnCreate">POST /reviews/create/{eventId}</button>
    <pre id="resCreate">–</pre>
</section>

<section>
    <h2>Update Review</h2>
    <label>Review ID:
        <input id="updId" type="number" placeholder="e.g. 456">
    </label>
    <label>New Text:
        <textarea id="updText" placeholder="Updated review…"></textarea>
    </label>
    <label>New Rating:
        <input id="updRating" type="number" min="1" max="5" value="4">
    </label>
    <button id="btnUpdate">PUT /reviews/{id}</button>
    <pre id="resUpdate">–</pre>
</section>

<section>
    <h2>Delete Review</h2>
    <label>Review ID:
        <input id="delId" type="number" placeholder="e.g. 789">
    </label>
    <button id="btnDelete">DELETE /reviews/{id}</button>
    <pre id="resDelete">–</pre>
</section>


<script>
    document.addEventListener("DOMContentLoaded", () => {
        const show = (id, txt) => document.getElementById(id).textContent = txt;

        const viewSelect = document.getElementById('viewSelect');
        const viewText   = document.getElementById('viewText');
        const viewRating = document.getElementById('viewRating');
        const viewRaw    = document.getElementById('viewRaw');

        viewSelect.addEventListener('change', async e => {
            const id = e.target.value;
            if (!id) {
                show('viewText','–'); show('viewRating','–'); show('viewRaw','–');
                return;
            }
            try {
                const res  = await fetch(`/reviews/${id}`);
                if (!res.ok) throw new Error(res.statusText);
                const json = await res.json();
                show('viewText',   json.reviewText);
                show('viewRating', json.rating);
                show('viewRaw',    JSON.stringify(json,null,2));
            } catch (err) {
                show('viewText','Error');
                show('viewRating','Error');
                show('viewRaw',err);
            }
        });

        document.getElementById('btnCreate').addEventListener('click', async () => {
            const eid  = document.getElementById('createEvent').value;
            const body = {
                reviewText: document.getElementById('createText').value,
                rating:     +document.getElementById('createRating').value
            };

            try {
                const res = await fetch(`/reviews/create/${eid}`, {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify(body)
                });

                if (res.ok) {
                    const data = await res.json();
                    const opt = document.createElement('option');
                    opt.value       = data.id;
                    opt.textContent = data.id;
                    viewSelect.appendChild(opt);
                    viewSelect.value = data.id;
                    show('resCreate', `Status: ${res.status}\n\n${JSON.stringify(data,null,2)}`);
                    show('viewText',   data.reviewText);
                    show('viewRating', data.rating);
                    show('viewRaw',    JSON.stringify(data,null,2));
                } else {
                    const err = await res.text();
                    show('resCreate', `Status: ${res.status}\n\n${err}`);
                }
            } catch (e) {
                show('resCreate','Error: '+e);
            }
        });

        document.getElementById('btnUpdate').addEventListener('click', async () => {
            const id   = document.getElementById('updId').value;
            const body = {
                reviewText: document.getElementById('updText').value,
                rating:     +document.getElementById('updRating').value
            };
            try {
                const res = await fetch(`/reviews/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify(body)
                });
                const txt = await res.text();
                show('resUpdate', `Status: ${res.status}\n\n${txt}`);

                if (res.ok && viewSelect.value === id) {
                    const updated = await fetch(`/reviews/${id}`).then(r => r.json());
                    show('viewText',   updated.reviewText);
                    show('viewRating', updated.rating);
                    show('viewRaw',    JSON.stringify(updated,null,2));
                }
            } catch (e) {
                show('resUpdate','Error: '+e);
            }
        });

        document.getElementById('btnDelete').addEventListener('click', async () => {
            const id = document.getElementById('delId').value;
            try {
                const res = await fetch(`/reviews/${id}`, { method: 'DELETE' });
                show('resDelete', `Status: ${res.status} ${res.statusText}`);

                if (res.ok) {
                    const opt = viewSelect.querySelector(`option[value="${id}"]`);
                    if (opt) opt.remove();
                    if (viewSelect.value === id) {
                        viewSelect.value = '';
                        show('viewText','–');
                        show('viewRating','–');
                        show('viewRaw','–');
                    }
                }
            } catch (e) {
                show('resDelete','Error: '+e);
            }
        });

    });
</script>

</body>
</html>
